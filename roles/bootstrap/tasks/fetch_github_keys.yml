- name: Create directory for keys
  ansible.builtin.file:
    path: "/tmp/github_keys"
    state: directory
    mode: '0700'
  delegate_to: localhost
  become: false

- name: Fetch all GitHub keys
  ansible.builtin.get_url:
    url: "https://github.com/{{ item }}.keys"
    dest: "/tmp/github_keys/{{ item }}.keys"
    mode: '0440'
  loop: "{{ bootstrap_default_user_authorized_keys_github }}"
  delegate_to: localhost
  become: false

- name: Combine all GitHub keys into one file
  ansible.builtin.shell: |
    for f in /tmp/github_keys/*.keys; do
      username=$(basename "$f" .keys)
      while IFS= read -r key; do
        echo "$key # github:$username"
      done < "$f"
    done > /tmp/github_keys/all_keys
  delegate_to: localhost
  become: false

- name: Copy combined keys to remote
  ansible.builtin.copy:
    src: "/tmp/github_keys/all_keys"
    dest: "/tmp/github_keys_remote"
    mode: '0440'

- name: Add all GitHub keys at once
  ansible.posix.authorized_key:
    user: "{{ bootstrap_default_user }}"
    state: present
    key: "{{ item }}"
  loop: "{{ lookup('file', '/tmp/github_keys_remote', errors='ignore').split('\n') | select('string') }}"

- name: Cleanup temporary files
  ansible.builtin.file:
    path: "/tmp/github_keys"
    state: absent
  delegate_to: localhost
  become: false 