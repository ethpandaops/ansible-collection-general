#!/bin/bash
set -euo pipefail

NETWORK="{{ snapshot_fetcher_network }}"
CLIENT="{{ snapshot_fetcher_client }}"
DATA_DIR="{{ snapshot_data_dir }}"
BLOCK="{{ block_number }}"
BASE_URL="{{ snapshot_base_url }}"

# Set tmux window title
printf '\033]2;%s\033\\' "Snapshot: $NETWORK-$CLIENT"

echo "=== Snapshot Download Started ==="
echo "Network: $NETWORK"
echo "Client: $CLIENT"
echo "Target Block: $BLOCK"
echo "================================"

# Get block info
echo "Fetching snapshot info for $NETWORK $CLIENT at block $BLOCK..."
BLOCK_INFO=$(curl -s "$BASE_URL/$NETWORK/$CLIENT/$BLOCK/_snapshot_eth_getBlockByNumber.json")
BLOCK_NUMBER=$(echo "$BLOCK_INFO" | jq -r '.result.number')
CLIENT_VERSION=$(curl -s "$BASE_URL/$NETWORK/$CLIENT/$BLOCK/_snapshot_web3_clientVersion.json" | jq -r '.result')

echo "Snapshot info:"
echo "Block: $BLOCK_NUMBER"
echo "Client: $CLIENT_VERSION"

# Download and extract
echo "Downloading and extracting snapshot..."
curl -s -L "$BASE_URL/$NETWORK/$CLIENT/$BLOCK/snapshot.tar.zst" | \
  tar -I zstd -xf - -C "$DATA_DIR"

echo "Snapshot downloaded and extracted to $DATA_DIR" 