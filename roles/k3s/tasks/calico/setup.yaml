---
- name: Create calico directory
  ansible.builtin.file:
    path: "{{ k3s_server_location }}/server/calico"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Set calico facts
  ansible.builtin.set_fact:
    k3s_custom_resources_defined: "{{ k3s_calico_custom_resources is defined and k3s_calico_custom_resources | trim | length > 0 }}"

- name: Check for network policies in all namespaces
  ansible.builtin.command:
    cmd: "k3s kubectl get networkpolicies --all-namespaces -o name"
  register: k3s_network_policies_check
  failed_when: false
  changed_when: false

- name: Set network policies fact
  ansible.builtin.set_fact:
    k3s_network_policies_exist: "{{ k3s_network_policies_check.rc == 0 and k3s_network_policies_check.stdout | trim != '' }}"

# Detection of pre-existing installation
- name: Check for existing Calico installation
  block:
    - name: Check if version file exists
      ansible.builtin.stat:
        path: "{{ k3s_calico_version_file }}"
      register: k3s_version_file_stat

    - name: Check if legacy operator exists (pre-version tracking)
      ansible.builtin.command:
        cmd: "k3s kubectl get -n tigera-operator deployment/tigera-operator -o name"
      register: k3s_legacy_operator_check
      failed_when: false
      changed_when: false

    - name: Check if legacy resources exist (pre-version tracking)
      ansible.builtin.command:
        cmd: "k3s kubectl get installation default -o name"
      register: k3s_legacy_install_check
      failed_when: false
      changed_when: false

- name: Read current version
  ansible.builtin.slurp:
    path: "{{ k3s_calico_version_file }}"
  register: k3s_current_version_b64
  when: k3s_version_file_stat.stat.exists

- name: Set version detection facts
  ansible.builtin.set_fact:
    k3s_current_calico_version: "{{ k3s_current_version_b64.content | b64decode | trim if k3s_version_file_stat.stat.exists else '' }}"
    k3s_legacy_calico_detected: "{{ not k3s_version_file_stat.stat.exists and (k3s_legacy_operator_check.rc == 0 or k3s_legacy_install_check.rc == 0) }}"

- name: Determine if version change is needed
  ansible.builtin.set_fact:
    k3s_calico_version_changed: "{{ not k3s_version_file_stat.stat.exists or k3s_current_calico_version != k3s_calico_version or k3s_legacy_calico_detected }}"
    k3s_calico_install_required: "{{ not k3s_version_file_stat.stat.exists and not k3s_legacy_calico_detected }}"

- name: Display Calico version comparison
  ansible.builtin.debug:
    msg:
      - "Version file exists: {{ k3s_version_file_stat.stat.exists }}"
      - "Current Calico version: {{ k3s_current_calico_version | default('Not installed') }}"
      - "Expected Calico version: {{ k3s_calico_version }}"
      - "Legacy Calico detected: {{ k3s_legacy_calico_detected }}"
      - "Version change detected: {{ k3s_calico_version_changed }}"
      - "Fresh install required: {{ k3s_calico_install_required }}"
      - >-
        Reason for change:
        {% if not k3s_version_file_stat.stat.exists and not k3s_legacy_calico_detected %}Fresh installation
        {% elif not k3s_version_file_stat.stat.exists %}Version file missing
        {% elif k3s_current_calico_version != k3s_calico_version %}Version mismatch ({{ k3s_current_calico_version }} != {{ k3s_calico_version }})
        {% elif k3s_legacy_calico_detected %}Legacy installation detected
        {% else %}No change needed{% endif %}
  tags:
    - calico
    - calico-check-version

# Check if operator file exists
- name: Check if tigera-operator file exists
  ansible.builtin.stat:
    path: "{{ k3s_calico_operator_file }}"
  register: k3s_operator_file_stat

- name: Set operator download needed fact
  ansible.builtin.set_fact:
    k3s_operator_download_needed: "{{ k3s_calico_version_changed or not k3s_operator_file_stat.stat.exists }}"
