#!/bin/sh
# Autogenerated by docker-gen. Do not edit.
set -eu

CERTSDIR="/etc/nginx/certs"
WCRT="{{ env "WILDCARD_CERT_NAME" }}.crt"
WKEY="{{ env "WILDCARD_CERT_NAME" }}.key"

if [ ! -s "$CERTSDIR/$WCRT" ] || [ ! -s "$CERTSDIR/$WKEY" ]; then
  echo "Wildcard cert/key not present: $CERTSDIR/$WCRT / $CERTSDIR/$WKEY" >&2
  exit 0
fi

{{ $containers := . }}
{{ range $container := $containers }}
  {{ $raw := index $container.Env "VIRTUAL_HOST" }}
  {{ $first := trim (first (split $raw "\n")) }}
  {{ $hosts := split $first "," }}
  {{ range $h := $hosts }}
    {{ $host := trim $h }}
# {{ $host }}
    {{ if $host }}
# relative symlinks so absolute mount paths don't matter
ln -sf "./$WCRT" "$CERTSDIR/{{ $host }}.crt"
ln -sf "./$WKEY" "$CERTSDIR/{{ $host }}.key"
    {{ end }}
  {{ end }}
{{ end }}