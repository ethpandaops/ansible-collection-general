#!/bin/bash

# Auto-generated script to apply network limits using tc
# Generated by Ansible on {{ ansible_date_time.date }} at {{ ansible_date_time.time }}
set -xe

{% for item in traffic_control_rules %}
#
# CONFIG FOR: {{ item.interface }}
#

NETNS_CMD=""
{% if item.container is defined %}
# If the container-specific network namespace exists, prepare to run commands there.
if [ -f "/var/run/netns/{{ item.container }}_ns" ]; then
  NETNS_CMD="ip netns exec {{ item.container }}_ns"
fi
{% endif %}

{% set ifb_interface = traffic_control_ifb_interface_prefix + item.interface %}
${NETNS_CMD} tc qdisc del dev {{ item.interface }} root
${NETNS_CMD} tc qdisc del dev {{ item.interface }} ingress
${NETNS_CMD} tc qdisc del dev {{ ifb_interface }} root
${NETNS_CMD} ip link set {{ ifb_interface }} down
${NETNS_CMD} ip link delete {{ ifb_interface }} type ifb

{% endfor %}
