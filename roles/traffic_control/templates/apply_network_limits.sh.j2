#!/bin/bash
# Auto-generated script to apply network limits using tc
# Generated by Ansible on {{ ansible_date_time.date }} at {{ ansible_date_time.time }}
set -e

{% for item in traffic_control_rules %}
#
# Applying network limits on interface {{ item.interface }}
#
#   Delete any existing qdisc configurations on {{ item.interface }}
tc qdisc del dev {{ item.interface }} root 2>/dev/null

{% if item.state != "absent" %}
#   Add root qdisc on {{ item.interface }}
tc qdisc add dev {{ item.interface }} root handle 1: htb default 1

#   Add bandwith limits on {{ item.interface }}
tc class add dev {{ item.interface }} parent 1: classid 1:1 htb rate {{ item.rate | default('1000mbit') }}

{% if item.latency is defined or item.jitter is defined %}
#   Add latency on {{ item.interface }}
tc qdisc add dev {{ item.interface }} parent 1:1 handle 10: netem \
{% if item.latency is defined %}delay {{ item.latency }}{% if item.jitter is defined %} {{ item.jitter }}{% endif %}{% endif %} \
{% if item.loss is defined %}loss {{ item.loss }}{% endif %}
{% endif %} # if item.latency is defined or item.jitter is defined

{% endif %} # if item.state != "absent"
{% endfor %}

# Additional custom commands
{% for item in traffic_control_rules_post_raw_cmds %}
{{ item }}
{% endfor %}
