#!/bin/bash

source "$(dirname "$0")/helpers.sh"

FLAGS="{{ hive_simulations.global_flags | join(' ') }}"
RESULT_PRUNE_OLDER_THAN="{{ hive_simulations.prune_test_results_older_than }}"

while true
do
  # Fetch the latest version of the hive repository and build the hive binary
  # Clean up docker containers and volumes and older logs
  updateRepo && updateIndex && pruneDocker && pruneTestResults $RESULT_PRUNE_OLDER_THAN

{% if hive_simulations.always_pull_images %}
  # Pull and build container images for all clients in all tests
  pullContainerImages "{{ hive_simulations.tests | map(attribute='clients') | list | flatten | unique | sort | join(',') }}"
{% endif %}

{% for test in hive_simulations.tests %}

  # SIMULATOR: {{ test.simulator }}
  for client in {{ test.clients | join(' ') }}; do
    runHiveTest '{{ test.simulator }}' "$client" "{{ test.extra_flags | join(' ') }} $FLAGS"
  done

{% endfor %}

done
